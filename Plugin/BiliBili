#!name = 哔哩哔哩
#!desc = 过滤客户端广告
#!icon = https://raw.githubusercontent.com/sooyaaabo/Loon/main/Icon/App-Icon/BilibiliPink.png
#!date = 2025-08-29

[Argument]
purifyTopReplies = switch, true, false, tag = 评论广告

[Rule]
DOMAIN,api.biliapi.com,REJECT
DOMAIN,app.biliapi.com,REJECT
DOMAIN,api.biliapi.net,REJECT
DOMAIN,app.biliapi.net,REJECT
AND,((DOMAIN-SUFFIX,chat.bilibili.com),(OR,((DOMAIN-KEYWORD,stun),(DOMAIN-KEYWORD,tracker)))),REJECT

[Rewrite]
^https:\/\/api\.bilibili\.com\/x\/vip\/ads\/materials mock-response-body data-type=json data="{}" status-code=200
^https:\/\/grpc\.biliapi\.net\/bilibili\.app\.interface\.v1\.Teenagers\/ModeStatus$ mock-response-body data-type=base64 data="AAAAABMKEQgCEgl0ZWVuYWdlcnMgAioA" mock-data-is-base64=true
^https:\/\/grpc\.biliapi\.net\/bilibili\.app\.interface\.v1\.Search\/DefaultWords$ mock-response-body data-type=base64 data="AAAAACkaHeaQnOe0ouinhumikeOAgeeVquWJp+aIlnVw5Li7IgAoAToAQgBKAA==" mock-data-is-base64=true
^https:\/\/grpc\.biliapi\.net\/bilibili\.app\.view\.v1\.View\/TFInfo$ mock-response-body data-type=base64 data="AAAAAAIIAQ==" mock-data-is-base64=true
^https:\/\/api\.bilibili\.com\/pgc\/page\/channel\?(.*)&mobi_app=iphone&(.*)$ header https://api.bilibili.com/pgc/page/channel?$1&mobi_app=iphone_i&$2 header

^https:\/\/app\.bilibili\.com\/x\/v2\/splash\/(list|show|event\/list2) response-body-json-jq '.data |= with_entries(if .key | IN("show", "event_list") then .value = [] else . end)'
^https:\/\/app\.bilibili\.com\/x\/v2\/search response-body-json-jq '.data |= map(select(.type != "recommend") | del(.search_ranking_meta))'
^https:\/\/app\.bilibili\.com\/x\/v2\/feed\/index\? response-body-json-jq '.data.items |= map(select((.banner_item == null) and (.ad_info == null) and (.card_goto == "av")))'
^https:\/\/app\.bilibili\.com\/x\/v2\/feed\/index\/story\? response-body-json-jq 'if .data.items then .data.items |= map(select((.ad_info == null) and (.card_goto | IN("vertical_ad_av","vertical_ad_live","vertical_ad_picture") | not)) | del(.story_cart_icon,.free_flow_toast,.image_infos,.course_info,.game_info)) end'
^https:\/\/app\.bilibili\.com\/x\/resource\/show\/tab response-body-json-jq '.config.tab_simplify = true | .data.tab |= map(select(.id == 40 or .id == 41 or .id == 3502 or .id == 3503)) | .data.bottom |= map(select(.id == 177 or .id == 179 or .id == 181)) | .data.top |= map(select(.id == 3510)) | .data.top_more = [] | .data.top_left = []'
^https:\/\/app\.bilibili\.com\/x\/v2\/account\/mine response-body-json-jq 'del(.data.modular_vip_section) | .data.show_creative = 0 | .data.sections_v2[] |= (del(.button) | if .title == "推荐服务" then del(.title) | .items |= map(select(.id == 396 or .id == 397 or .id == 3072 or .id == 2830)) elif .title == "更多服务" then del(.title) | .items |= map(select(.id == 407 or .id == 410) | if .id == 410 then .title = "我的设置" else . end) else . end) | .data.sections_v2 |= map(select(.items | length > 0))'
^https:\/\/app\.bilibili\.com\/x\/v2\/account\/mine\/ipad response-body-json-jq '.data.ipad_recommend_sections |= map(select(.id != 758 and .id != 759 and .id != 760 and .id != 792 and .id != 793 and .id != 2542 and .id != 794)) | .data.ipad_more_sections |= map(select(.id != 1070 and .id != 965) | if .id == 798 then .title = "我的设置" | . else . end) | del(.data.ipad_upper_sections)'

[Script]
http-response ^https:\/\/(grpc\.biliapi\.net|app\.bilibili\.com)\/bilibili\.(app\.(show\.v1\.Popular\/Index|dynamic\.v2\.Dynamic\/DynAll|view(unite)?\.v1\.View\/(View|ViewProgress|RelatesFeed)|playurl\.v1\.PlayURL\/PlayView|playerunite\.v1\.Player\/PlayViewUnite)|polymer\.app\.search\.v1\.Search\/SearchAll|community\.service\.dm\.v1\.DM\/DmView|main\.community\.reply\.v1\.Reply\/MainList|pgc\.gateway\.player\.v2\.PlayURL\/PlayView)$ script-path=https://raw.githubusercontent.com/kokoryh/Sparkle/master/dist/bilibili.protobuf.response.js, requires-body=true, binary-body-mode=true, timeout=10, tag=配置处理, argument=[{purifyTopReplies}]

[MitM]
hostname = grpc.biliapi.net,app.bilibili.com,api.bilibili.com
